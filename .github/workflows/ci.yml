name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  discover-versions:
    runs-on: ubuntu-latest
    name: Discover versions to benchmark
    outputs:
      versions: ${{ steps.discover.outputs.versions }}
      latest: ${{ steps.discover.outputs.latest }}
      has_versions: ${{ steps.discover.outputs.has_versions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover un-benchmarked versions
        id: discover
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all non-draft, non-prerelease releases
          releases=$(curl -sS -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/AiBrush/coreutils-rs/releases?per_page=100" | \
            python3 -c "
          import sys, json
          releases = json.load(sys.stdin)
          tags = []
          for r in releases:
              if not r.get('draft') and not r.get('prerelease'):
                  tags.append(r['tag_name'])
          # Sort by version number
          import re
          def ver(t):
              m = re.match(r'v?(\d+)\.(\d+)\.(\d+)', t)
              return (int(m.group(1)), int(m.group(2)), int(m.group(3))) if m else (0,0,0)
          tags.sort(key=ver)
          for t in tags:
              print(t)
          ")

          echo "All releases:"
          echo "$releases"

          # Check which versions already have results
          new_versions=()
          latest=""
          for tag in $releases; do
              latest="$tag"
              # Check if results exist for this version on any platform
              if [[ -d "results/benchmarks/$tag" ]] && ls results/benchmarks/$tag/*.json &>/dev/null; then
                  echo "  $tag: already benchmarked, skipping"
              else
                  echo "  $tag: NEW — will benchmark"
                  new_versions+=("$tag")
              fi
          done

          # Limit to 5 versions per run to avoid CI timeout
          # (results accumulate across runs — daily schedule catches up)
          MAX_VERSIONS=5
          if [[ ${#new_versions[@]} -gt $MAX_VERSIONS ]]; then
              echo "Limiting to $MAX_VERSIONS versions (${#new_versions[@]} total new)"
              new_versions=("${new_versions[@]: -$MAX_VERSIONS}")
          fi

          # Build JSON array of new versions
          json_versions=$(printf '%s\n' "${new_versions[@]}" | python3 -c "
          import sys, json
          versions = [l.strip() for l in sys.stdin if l.strip()]
          print(json.dumps(versions))
          ")

          echo "versions=$json_versions" >> "$GITHUB_OUTPUT"
          echo "latest=$latest" >> "$GITHUB_OUTPUT"
          if [[ ${#new_versions[@]} -gt 0 ]]; then
              echo "has_versions=true" >> "$GITHUB_OUTPUT"
          else
              echo "has_versions=false" >> "$GITHUB_OUTPUT"
          fi

          echo ""
          echo "New versions to benchmark: ${new_versions[*]:-none}"
          echo "Latest release: $latest"

  compatibility:
    needs: discover-versions
    if: needs.discover-versions.outputs.latest != ''
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            name: Linux x86_64
          - os: ubuntu-24.04-arm
            arch: arm64
            name: Linux ARM64
          - os: macos-latest
            arch: arm64
            name: macOS ARM64
          - os: windows-latest
            arch: x86_64
            name: Windows x86_64
          # windows-11-arm excluded: no pre-built ARM64 Windows binaries available

    runs-on: ${{ matrix.os }}
    name: Tests - ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install fcoreutils from GitHub releases
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/install_from_github.sh
          INSTALL_DIR="$HOME/.local/bin" ./scripts/install_from_github.sh --version "${{ needs.discover-versions.outputs.latest }}"
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install GNU coreutils (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install coreutils
          for tool in wc cut sha256sum md5sum b2sum base64 sort tr uniq tac; do
            if command -v g$tool &>/dev/null; then
              sudo ln -sf "$(which g$tool)" "/usr/local/bin/$tool"
            fi
          done
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Install GNU coreutils (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "Using system coreutils from Git Bash"
          which wc cut sha256sum md5sum sort tr uniq || echo "Some tools may be missing on Windows"

      - name: Verify tool installation
        shell: bash
        run: |
          echo "=== fcoreutils ==="
          for tool in fwc fcut fsha256sum fmd5sum fb2sum fbase64 fsort ftr funiq ftac; do
            if command -v $tool &>/dev/null; then
              echo "  $tool: $(which $tool)"
            else
              echo "  $tool: NOT FOUND"
            fi
          done

          echo ""
          echo "=== GNU coreutils ==="
          for tool in wc cut sha256sum md5sum b2sum base64 sort tr uniq tac; do
            if command -v $tool &>/dev/null; then
              echo "  $tool: $(which $tool)"
            else
              echo "  $tool: NOT FOUND"
            fi
          done

      - name: Install Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Make test scripts executable
        shell: bash
        run: chmod +x tests/compatibility/*.sh tests/helpers/*.sh tests/stress/*.sh 2>/dev/null || true

      - name: Run compatibility tests
        shell: bash
        run: |
          export RESULTS_DIR="${GITHUB_WORKSPACE}/results"
          export TEST_DATA_DIR="/tmp/fcoreutils-test-data"
          mkdir -p "$RESULTS_DIR"
          bash tests/compatibility/run_all.sh || true

      - name: Run stress tests
        shell: bash
        run: |
          export RESULTS_DIR="${GITHUB_WORKSPACE}/results"
          export TEST_DATA_DIR="/tmp/fcoreutils-test-data"
          bash tests/stress/stress_tests.sh || true

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compatibility-results-${{ matrix.os }}-${{ matrix.arch }}
          path: results/
          retention-days: 30

      - name: Upload failed tests
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failed-tests-${{ matrix.os }}-${{ matrix.arch }}
          path: tests/failed_tests/
          retention-days: 30
          if-no-files-found: ignore

      - name: Print summary
        if: always()
        shell: bash
        run: |
          echo "## Compatibility Results - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ -f "results/compatibility_results.json" ]]; then
            python3 -c "
          import json
          d = json.load(open('results/compatibility_results.json'))
          s = d['summary']
          print(f\"| Metric | Value |\")
          print(f\"|--------|-------|\")
          print(f\"| Total Tests | {s['total_tests']} |\")
          print(f\"| Passed | {s['passed']} |\")
          print(f\"| Failed | {s['failed']} |\")
          print(f\"| Skipped | {s['skipped']} |\")
          print(f\"| Tools Tested | {s['tools_tested']} |\")
          print(f\"| Tools Skipped | {s['tools_skipped']} |\")
          " >> $GITHUB_STEP_SUMMARY
          else
            echo "No results file found." >> $GITHUB_STEP_SUMMARY
          fi

  benchmarks:
    needs: discover-versions
    if: needs.discover-versions.outputs.has_versions == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            name: Linux x86_64
          - os: ubuntu-24.04-arm
            arch: arm64
            name: Linux ARM64
          - os: macos-latest
            arch: arm64
            name: macOS ARM64
          - os: windows-latest
            arch: x86_64
            name: Windows x86_64
          # windows-11-arm excluded: no pre-built ARM64 Windows binaries available

    runs-on: ${{ matrix.os }}
    name: Bench - ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain (for hyperfine)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-bench-

      - name: Install hyperfine
        shell: bash
        run: |
          if ! command -v hyperfine &>/dev/null; then
            cargo install hyperfine
          fi

      - name: Install GNU coreutils (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install coreutils
          for tool in wc cut sha256sum md5sum b2sum base64 sort tr uniq tac; do
            if command -v g$tool &>/dev/null; then
              sudo ln -sf "$(which g$tool)" "/usr/local/bin/$tool"
            fi
          done
          echo "/usr/local/bin" >> $GITHUB_PATH

      - name: Install Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Make scripts executable
        shell: bash
        run: chmod +x tests/benchmarks/*.sh tests/helpers/*.sh scripts/*.sh 2>/dev/null || true

      - name: Benchmark all new versions
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSIONS='${{ needs.discover-versions.outputs.versions }}'
          echo "Versions to benchmark: $VERSIONS"

          # Detect platform tag for result filenames
          OS_NAME=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)
          PLATFORM_TAG="${OS_NAME}_${ARCH}"

          # Parse JSON array into newline-separated list (portable, no readarray)
          VERSION_LIST=$(echo "$VERSIONS" | python3 -c "
          import sys, json
          versions = json.load(sys.stdin)
          for v in versions:
              print(v)
          ")

          echo "$VERSION_LIST" | while IFS= read -r VERSION; do
              [[ -z "$VERSION" ]] && continue
              echo ""
              echo "============================================================"
              echo "  Benchmarking $VERSION on $PLATFORM_TAG"
              echo "============================================================"

              # Install this version (skip if no asset available)
              if ! INSTALL_DIR="$HOME/.local/bin" ./scripts/install_from_github.sh --version "$VERSION"; then
                  echo "WARNING: Could not install $VERSION — skipping"
                  continue
              fi
              export PATH="$HOME/.local/bin:$PATH"

              # Run benchmarks
              export RESULTS_DIR="${GITHUB_WORKSPACE}/bench_tmp"
              export TEST_DATA_DIR="/tmp/fcoreutils-test-data"
              export GENERATE_LARGE=true
              export BENCH_WARMUP=3
              export BENCH_RUNS=10
              mkdir -p "$RESULTS_DIR"
              bash tests/benchmarks/run_all.sh || true

              # Copy aggregate results to versioned directory
              DEST_DIR="${GITHUB_WORKSPACE}/versioned_results/benchmarks/${VERSION}"
              mkdir -p "$DEST_DIR"
              if [[ -f "$RESULTS_DIR/benchmark_results.json" ]]; then
                  cp "$RESULTS_DIR/benchmark_results.json" "$DEST_DIR/${PLATFORM_TAG}.json"
                  echo "Saved: $DEST_DIR/${PLATFORM_TAG}.json"
              fi

              # Run compatibility tests too
              export RESULTS_DIR="${GITHUB_WORKSPACE}/compat_tmp"
              mkdir -p "$RESULTS_DIR"
              bash tests/compatibility/run_all.sh || true

              COMPAT_DEST="${GITHUB_WORKSPACE}/versioned_results/compatibility/${VERSION}"
              mkdir -p "$COMPAT_DEST"
              if [[ -f "$RESULTS_DIR/compatibility_results.json" ]]; then
                  cp "$RESULTS_DIR/compatibility_results.json" "$COMPAT_DEST/${PLATFORM_TAG}.json"
                  echo "Saved: $COMPAT_DEST/${PLATFORM_TAG}.json"
              fi

              # Cleanup for next version
              rm -rf "${GITHUB_WORKSPACE}/bench_tmp" "${GITHUB_WORKSPACE}/compat_tmp"
          done || true

      - name: Upload versioned results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: versioned-results-${{ matrix.os }}-${{ matrix.arch }}
          path: versioned_results/
          retention-days: 90

      - name: Print summary
        if: always()
        shell: bash
        run: |
          echo "## Benchmark Results - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Benchmarked versions: ${{ needs.discover-versions.outputs.versions }}" >> $GITHUB_STEP_SUMMARY

  report:
    needs: [discover-versions, compatibility, benchmarks]
    if: always() && github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    name: Publish Report

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python 3
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install matplotlib

      - name: Download versioned results
        uses: actions/download-artifact@v4
        with:
          pattern: versioned-results-*
          path: new_results/
          merge-multiple: true
        continue-on-error: true

      - name: Merge new results into results/
        shell: bash
        run: |
          echo "=== New results from this CI run ==="
          find new_results/ -type f 2>/dev/null | head -50 || echo "No new results"

          # Merge new versioned results into the repo's results/ directory
          if [[ -d "new_results/benchmarks" ]]; then
              for version_dir in new_results/benchmarks/v*/; do
                  version=$(basename "$version_dir")
                  dest="results/benchmarks/${version}"
                  mkdir -p "$dest"
                  cp -v "$version_dir"*.json "$dest/" 2>/dev/null || true
              done
          fi

          if [[ -d "new_results/compatibility" ]]; then
              for version_dir in new_results/compatibility/v*/; do
                  version=$(basename "$version_dir")
                  dest="results/compatibility/${version}"
                  mkdir -p "$dest"
                  cp -v "$version_dir"*.json "$dest/" 2>/dev/null || true
              done
          fi

          echo ""
          echo "=== All results ==="
          find results/ -type f | sort | head -100 || echo "No results"

      - name: Generate report and chart
        run: python3 scripts/generate_report.py

      - name: Commit results and report
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git pull --rebase || true
          git add results/ README.md || true
          git rm REPORT.md 2>/dev/null || true
          git diff --cached --quiet || git commit -m "Update test report [skip ci]"
          git push || true
